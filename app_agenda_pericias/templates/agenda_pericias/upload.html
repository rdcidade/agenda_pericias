{% extends 'agenda_pericias/base.html' %}
{% block content %}
<body>
    <div class="container" style="padding-top: 5%;">
        <div class="content">    
            <!--FORMULÁRIO DE CADASTRO-->
            <form method="post" action="{% url 'import_excel' %}" id="upload" enctype="multipart/form-data">
                {% csrf_token %}
                <h1>Importar de Pauta de Perícias Agendadas</h1>
                <p style="text-align: center;"> 
                    <input type="file" name="file" id="file" accept=".xlsx" required>
                    <button class="btn btn-primary" style="margin-top: 15px;" type="submit">Importar</button>
                </p>
                <div class="row">
                    <div class="col-md-12 py-3">
                        <div id="progresso" class="progress">
                            <div class="progress-bar bg-success" id="progresso_upload" style="width: 0%;" aria-valuenow="0"
                                aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div>
            {% if messages %}
            <ul>
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}        
        </div>    
        {% if messages %}
        <ul>
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>
    function upload(event) {
        event.preventDefault();
        var data = new FormData($('#upload').get(0));

        $.ajax({
            xhr: function () {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function (evt) {
                    if (evt.lengthComputable) {
                        var totalCompleto = (evt.loaded / evt.total) * 100;
                        porcentagem_int = parseInt(totalCompleto);
                        $("#progresso_upload").attr('aria-valuenow', totalCompleto).css('width', totalCompleto + '%').text(porcentagem_int + '%');
                    }
                }, false);
                return xhr;
            },

            url: $(this).attr('action'),
            type: $(this).attr('method'),
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success: function (data) {
                alert("Arquivos salvos");
            },
            statusCode: {
                500: function () {
                    alert("Problema no Upload")
                }
            }
        });
        return false;
    }

    $(function () {
        $('#upload').submit(upload);
    });
</script>
{% endblock %}
